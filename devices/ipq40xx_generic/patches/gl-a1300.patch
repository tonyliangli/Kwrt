From c4ef992c4f0e3c5fce6b7bf0feae4d20c7f8af67 Mon Sep 17 00:00:00 2001
From: Weiping Yang <weiping.yang@gl-inet.com>
Date: Mon, 19 Sep 2022 05:47:40 -0400
Subject: [PATCH] ipq40xx: add support for GL.iNet GL-A1300 Specifications:
 SOC:		Qualcomm IPQ4018 (DAKOTA) ARM Quad-Core RAM:		256
 MiB FLASH1:		4 MiB NOR FLASH2:		128 MiB NAND ETH:
 	Qualcomm QCA8075 WLAN1:		Qualcomm Atheros QCA4018 2.4GHz
 802.11b/g/n 2x2 WLAN2:		Qualcomm Atheros QCA4018 5G 802.11n/ac W2 2x2
 USB:		1 x USB 3.0 port Button:		1 x Reset button
 Switch:		1 x Mode switch LED:		1 x Blue LED + 1 x
 White LED

Install via uboot tftp or uboot web failsafe.

By uboot tftp:
(IPQ40xx) # tftpboot 0x84000000 openwrt-ipq40xx-generic-glinet_gl-a1300-squashfs-nand-factory.ubi
(IPQ40xx) # nand erase 0 0x8000000
(IPQ40xx) # nand write 0x84000000 0 $filesize

By uboot web failsafe:
Push the reset button for 10 seconds util the power led flash faster,
then use broswer to access http://192.168.1.1

Afterwards upgrade can use sysupgrade image.

Signed-off-by: Weiping Yang <weiping.yang@gl-inet.com>
---
 package/boot/uboot-envtools/files/ipq40xx     |   1 +
 package/firmware/ipq-wifi/Makefile            |   2 +
 .../ipq-wifi/board-glinet_gl-a1300.qca4019    | Bin 0 -> 24308 bytes
 .../ipq40xx/base-files/etc/board.d/02_network |   1 +
 .../base-files/lib/upgrade/platform.sh        |   1 +
 .../arm/boot/dts/qcom-ipq4018-gl-a1300.dts    | 326 ++++++++++++++++++
 target/linux/ipq40xx/image/generic.mk         |  14 +
 7 files changed, 345 insertions(+)
 create mode 100644 package/firmware/ipq-wifi/board-glinet_gl-a1300.qca4019
 create mode 100644 target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4018-gl-a1300.dts

diff --git a/package/boot/uboot-envtools/files/ipq40xx b/package/boot/uboot-envtools/files/ipq40xx
index e45e26dcc7f75..d421e02ac3cb0 100644
--- a/package/boot/uboot-envtools/files/ipq40xx
+++ b/package/boot/uboot-envtools/files/ipq40xx
@@ -33,6 +33,7 @@ case "$board" in
 alfa-network,ap120c-ac|\
 devolo,magic-2-wifi-next|\
 edgecore,ecw5211|\
+glinet,gl-a1300 |\
 glinet,gl-ap1300|\
 glinet,gl-b1300|\
 glinet,gl-b2200|\
diff --git a/package/firmware/ipq-wifi/Makefile b/package/firmware/ipq-wifi/Makefile
index da82e16dde165..2096b5f2d6be3 100644
--- a/package/firmware/ipq-wifi/Makefile
+++ b/package/firmware/ipq-wifi/Makefile
@@ -30,6 +30,7 @@ ALLWIFIBOARDS:= \
 	edgecore_ecw5410 \
 	edgecore_oap100 \
 	extreme-networks_ws-ap3915i \
+	glinet_gl-a1300 \
 	glinet_gl-ap1300 \
 	glinet_gl-s1300 \
 	linksys_ea8300 \
@@ -105,6 +106,7 @@ $(eval $(call generate-ipq-wifi-package,devolo_magic-2-wifi-next,devolo Magic 2
 $(eval $(call generate-ipq-wifi-package,edgecore_ecw5410,Edgecore ECW5410))
 $(eval $(call generate-ipq-wifi-package,edgecore_oap100,Edgecore OAP100))
 $(eval $(call generate-ipq-wifi-package,extreme-networks_ws-ap3915i,Edgecore OAP100))
+$(eval $(call generate-ipq-wifi-package,glinet_gl-a1300,GL.iNet GL-A1300))
 $(eval $(call generate-ipq-wifi-package,glinet_gl-ap1300,GL.iNet GL-AP1300))
 $(eval $(call generate-ipq-wifi-package,glinet_gl-s1300,GL.iNet GL-S1300))
 $(eval $(call generate-ipq-wifi-package,linksys_ea8300,Linksys EA8300))
diff --git a/package/firmware/ipq-wifi/board-glinet_gl-a1300.qca4019 b/package/firmware/ipq-wifi/board-glinet_gl-a1300.qca4019
new file mode 100644
index 0000000000000000000000000000000000000000..d8695c983641b25f4e059f65a0ce8b4f2501338c
GIT binary patch
literal 24308
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
bmh2gu<JcRvFYQ^*KRSwUztHcJ*7f&))|DRQ

literal 0
HcmV?d00001

diff --git a/target/linux/ipq40xx/base-files/etc/board.d/02_network b/target/linux/ipq40xx/base-files/etc/board.d/02_network
index c24e4c83739ac..e85bf4567d07c 100644
--- a/target/linux/ipq40xx/base-files/etc/board.d/02_network
+++ b/target/linux/ipq40xx/base-files/etc/board.d/02_network
@@ -57,6 +57,7 @@ ipq40xx_setup_interfaces()
 	compex,wpj428)
 		ucidef_set_interface_lan "lan1 lan2"
 		;;
+	glinet,gl-a1300|\
 	glinet,gl-b1300|\
 	mobipromo,cm520-79f)
 		ucidef_set_interfaces_lan_wan "lan1 lan2" "wan"
diff --git a/target/linux/ipq40xx/base-files/lib/upgrade/platform.sh b/target/linux/ipq40xx/base-files/lib/upgrade/platform.sh
index fa5f171a30130..8bffd92e2f84a 100644
--- a/target/linux/ipq40xx/base-files/lib/upgrade/platform.sh
+++ b/target/linux/ipq40xx/base-files/lib/upgrade/platform.sh
@@ -111,6 +111,7 @@ platform_do_upgrade() {
 	edgecore,ecw5211 |\
 	edgecore,oap100 |\
 	engenius,eap2200 |\
+	glinet,gl-a1300 |\
 	glinet,gl-ap1300 |\
 	luma,wrtq-329acn |\
 	mobipromo,cm520-79f |\
diff --git a/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4018-gl-a1300.dts b/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4018-gl-a1300.dts
new file mode 100644
index 0000000000000..5993243dc9775
--- /dev/null
+++ b/target/linux/ipq40xx/files/arch/arm/boot/dts/qcom-ipq4018-gl-a1300.dts
@@ -0,0 +1,326 @@
+// SPDX-License-Identifier: GPL-2.0-or-later OR MIT
+
+#include "qcom-ipq4019.dtsi"
+#include <dt-bindings/gpio/gpio.h>
+#include <dt-bindings/input/input.h>
+#include <dt-bindings/soc/qcom,tcsr.h>
+
+/ {
+	model = "GL.iNet GL-A1300";
+	compatible = "glinet,gl-a1300", "qcom,ipq4019";
+
+	aliases {
+		led-boot = &led_run;
+		led-failsafe = &led_run;
+		led-running = &led_run;
+		led-upgrade = &led_run;
+		label-mac-device = &swport4;
+	};
+
+	chosen {
+		bootargs-append = " ubi.mtd=ubi root=/dev/ubiblock0_1";
+	};
+
+	soc {
+		tcsr@1949000 {
+			compatible = "qcom,tcsr";
+			reg = <0x1949000 0x100>;
+			qcom,wifi_glb_cfg = <TCSR_WIFI_GLB_CFG>;
+		};
+
+		tcsr@194b000 {
+			/* select hostmode */
+			compatible = "qcom,tcsr";
+			reg = <0x194b000 0x100>;
+			qcom,usb-hsphy-mode-select = <TCSR_USB_HSPHY_HOST_MODE>;
+			status = "okay";
+		};
+
+		ess_tcsr@1953000 {
+			compatible = "qcom,tcsr";
+			reg = <0x1953000 0x1000>;
+			qcom,ess-interface-select = <TCSR_ESS_PSGMII>;
+		};
+
+		tcsr@1957000 {
+			compatible = "qcom,tcsr";
+			reg = <0x1957000 0x100>;
+			qcom,wifi_noc_memtype_m0_m2 = <TCSR_WIFI_NOC_MEMTYPE_M0_M2>;
+		};
+	};
+
+	keys {
+		compatible = "gpio-keys";
+
+		reset {
+			label = "reset";
+			gpios = <&tlmm 63 GPIO_ACTIVE_LOW>;
+			linux,code = <KEY_RESTART>;
+		};
+
+		switch {
+			label = "switch-button";
+			gpios = <&tlmm 0 GPIO_ACTIVE_LOW>;
+			linux,code = <KEY_SETUP>;
+		};
+	};
+
+	leds {
+		compatible = "gpio-leds";
+
+		led_run: blue {
+			label = "blue:status";
+			gpios = <&tlmm 2 GPIO_ACTIVE_HIGH>;
+		};
+
+		white {
+			label = "white:status";
+			gpios = <&tlmm 1 GPIO_ACTIVE_HIGH>;
+		};
+	};
+
+	gpio_export {
+		compatible = "gpio-export";
+
+		usb {
+			gpio-export,name = "usb_power";
+			gpio-export,output = <1>;
+			gpios = <&tlmm 4 GPIO_ACTIVE_HIGH>;
+		};
+	};
+};
+
+&prng {
+	status = "okay";
+};
+
+&mdio {
+	status = "okay";
+};
+
+&blsp_dma {
+	status = "okay";
+};
+
+&watchdog {
+	status = "okay";
+};
+
+&crypto {
+	status = "okay";
+};
+
+&cryptobam {
+	status = "okay";
+};
+
+&blsp1_spi1 {
+	status = "okay";
+
+	pinctrl-0 = <&spi0_pins>;
+	pinctrl-names = "default";
+	cs-gpios = <&tlmm 54 GPIO_ACTIVE_HIGH>, <&tlmm 5 GPIO_ACTIVE_HIGH>;
+
+	flash@0 {
+		compatible = "jedec,spi-nor";
+		reg = <0>;
+		spi-max-frequency = <24000000>;
+
+		partitions {
+			compatible = "fixed-partitions";
+			#address-cells = <1>;
+			#size-cells = <1>;
+
+			partition@0 {
+				label = "SBL1";
+				reg = <0x00000000 0x00040000>;
+				read-only;
+			};
+
+			partition@40000 {
+				label = "MIBIB";
+				reg = <0x00040000 0x00020000>;
+				read-only;
+			};
+
+			partition@60000 {
+				label = "QSEE";
+				reg = <0x00060000 0x00060000>;
+				read-only;
+			};
+
+			partition@c0000 {
+				label = "CDT";
+				reg = <0x000c0000 0x00010000>;
+				read-only;
+			};
+
+			partition@d0000 {
+				label = "DDRPARAMS";
+				reg = <0x000d0000 0x00010000>;
+				read-only;
+			};
+
+			partition@e0000 {
+				label = "APPSBLENV"; /* uboot env*/
+				reg = <0x000e0000 0x00010000>;
+			};
+
+			partition@f0000 {
+				label = "APPSBL"; /* uboot */
+				reg = <0x000f0000 0x00080000>;
+				read-only;
+			};
+
+			partition@170000 {
+				label = "ART";
+				reg = <0x00170000 0x00010000>;
+				read-only;
+				compatible = "nvmem-cells";
+
+				precal_art_1000: precal@1000 {
+					reg = <0x1000 0x2f20>;
+				};
+
+				precal_art_5000: precal@5000 {
+					reg = <0x5000 0x2f20>;
+				};
+
+				macaddr_gmac0: macaddr@0 {
+					reg = <0x0 0x6>;
+				};
+
+				macaddr_gmac1: macaddr@6 {
+					reg = <0x6 0x6>;
+				};
+			};
+
+			partition@180000 {
+                                label = "log";
+                                reg = <0x00180000 0x00020000>;
+                        };
+		};
+	};
+
+	spi-nand@1 {
+		compatible = "spi-nand";
+		reg = <1>;
+		spi-max-frequency = <24000000>;
+
+		partitions {
+			compatible = "fixed-partitions";
+			#address-cells = <1>;
+			#size-cells = <1>;
+
+			partition@0 {
+				label = "ubi";
+				reg = <0x00000000 0x08000000>;
+			};
+		};
+	};
+};
+
+&blsp1_uart1 {
+	pinctrl-0 = <&serial_pins>;
+	pinctrl-names = "default";
+	status = "okay";
+};
+
+&tlmm {
+	serial_pins: serial_pinmux {
+		mux {
+			pins = "gpio60", "gpio61";
+			function = "blsp_uart0";
+			bias-disable;
+		};
+	};
+
+	i2c_0_pins: i2c_0_pinmux {
+		pinmux {
+			pins = "gpio58", "gpio59";
+			function = "blsp_i2c0";
+			bias-disable;
+		};
+	};
+
+	spi0_pins: spi0_pinmux {
+		mux_spi {
+			function = "blsp_spi0";
+			pins = "gpio55", "gpio56", "gpio57";
+			drive-strength = <12>;
+			bias-disable;
+		};
+
+		mux_cs {
+			function = "gpio";
+			pins = "gpio54", "gpio5";
+			drive-strength = <2>;
+			bias-disable;
+			output-high;
+		};
+	};
+};
+
+&blsp1_i2c3 {
+        status = "okay";
+        pinctrl-0 = <&i2c_0_pins>;
+        pinctrl-names = "default";
+};
+
+&usb2_hs_phy {
+	status = "okay";
+};
+
+&usb3_hs_phy {
+	status = "okay";
+};
+
+&usb3_ss_phy {
+	status = "okay";
+};
+
+&gmac {
+	status = "okay";
+};
+
+&switch {
+	status = "okay";
+};
+
+&swport3 {
+	status = "okay";
+
+	label = "lan2";
+	nvmem-cell-names = "mac-address";
+	nvmem-cells = <&macaddr_gmac0>;
+	mac-address-increment = <2>;
+};
+
+&swport4 {
+	status = "okay";
+
+	label = "lan1";
+	nvmem-cell-names = "mac-address";
+	nvmem-cells = <&macaddr_gmac0>;
+};
+
+&swport5 {
+	status = "okay";
+
+	nvmem-cell-names = "mac-address";
+	nvmem-cells = <&macaddr_gmac1>;
+};
+
+&wifi0 {
+	status = "okay";
+	nvmem-cell-names = "pre-calibration";
+	nvmem-cells = <&precal_art_1000>;
+	qcom,ath10k-calibration-variant = "GL-A1300";
+};
+
+&wifi1 {
+	status = "okay";
+	nvmem-cell-names = "pre-calibration";
+	nvmem-cells = <&precal_art_5000>;
+	qcom,ath10k-calibration-variant = "GL-A1300";
+};
diff --git a/target/linux/ipq40xx/image/generic.mk b/target/linux/ipq40xx/image/generic.mk
index e8e6e29e72792..b50d072bec34b 100644
--- a/target/linux/ipq40xx/image/generic.mk
+++ b/target/linux/ipq40xx/image/generic.mk
@@ -565,6 +565,20 @@ endef
 # Missing DSA Setup
 #TARGET_DEVICES += ezviz_cs-w3-wd1200g-eup
 
+define Device/glinet_gl-a1300
+	$(call Device/FitImage)
+	$(call Device/UbiFit)
+	DEVICE_VENDOR := GL.iNet
+	DEVICE_MODEL := GL-A1300
+	SOC := qcom-ipq4018
+	DEVICE_DTS_CONFIG := config@ap.dk01.1-c2
+	BLOCKSIZE := 128k
+	PAGESIZE := 2048
+	IMAGE_SIZE := 131072k
+	DEVICE_PACKAGE := ipq-wifi-glinet_gl-a1300
+endef
+TARGET_DEVICES += glinet_gl-a1300
+
 define Device/glinet_gl-ap1300
 	$(call Device/FitImage)
 	$(call Device/UbiFit)
